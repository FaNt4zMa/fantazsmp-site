<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fantaz's SMP - Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>
<body class="home-page">
  <header>
    <p><img src="images/fantaz-smp-banner.png" alt="Fantaz's SMP"></p>
  </header>

  <nav>
    <a href="index" class="active">Home</a>
    <a href="info">Server Info</a>
    <a href="rules">Rules</a>
    <a href="join">How to Join?</a>
    <a href="modpack">My Modpack</a>
    <a href="map">Real Time Map</a>
  </nav>

  <main>
    <section class="card stats" aria-live="polite">
      <h2>Server Statistics</h2>
      <div class="stat-grid">
        <div class="stat">
          <span class="label">Uptime</span>
          <span id="uptime" class="value">Loading...</span>
        </div>
        <div class="stat">
          <span class="label">Players</span>
          <span id="players" class="value">Loading...</span>
        </div>
        <div class="stat">
          <span class="label">CPU / RAM</span>
          <span id="resources" class="value">Loading...</span>
        </div>
        <div class="stat">
          <span class="label">World Size</span>
          <span id="worldsize" class="value">Loading...</span>
        </div>
        <div class="stat">
          <span class="label">MOTD</span>
          <span id="motd" class="value">Loading...</span>
        </div>
        <div class="stat">
          <span class="label">Version</span>
          <span id="version" class="value">Loading...</span>
        </div>
      </div>
    </section>

    <section class="map card" aria-label="World Map">
      <div class="map-header">
        <a id="map-fullscreen" href="" target="_blank" rel="noopener">View Fullscreen</a>
      </div>
      <iframe id="map-iframe" src=""></iframe>
    </section>
  </main>

  <footer>
    <hr>
    © 2025 Fantaz's SMP — All Rights Reserved
  </footer>

  <script src="config.js"></script>
  <script>
    
    document.getElementById("map-iframe").src = CONFIG.mapUrl;
    document.getElementById("map-fullscreen").href = CONFIG.mapUrl;

    const $ = (sel) => document.querySelector(sel);

    function safeParseDate(dt) {
      if (!dt) return NaN;
      const m = dt.match(/^(\d{4}-\d{2}-\d{2}) (\d{2}:\d{2}:\d{2})$/);
      if (m) {
        return Date.parse(m[1] + "T" + m[2] + "Z");
      }
      return Date.parse(dt);
    }

    function formatUptimeFromStarted(started) {
      const start = safeParseDate(started);
      if (isNaN(start)) return "—";
      const diff = Math.floor((Date.now() - start) / 1000);
      const d = Math.floor(diff / 86400);
      const h = Math.floor((diff % 86400) / 3600);
      const m = Math.floor((diff % 3600) / 60);
      return `${d}d ${h}h ${m}m`;
    }

    function setOffline() {
      ["#uptime","#players","#resources","#worldsize","#motd","#version"]
        .forEach(sel => $(sel).textContent = "Offline");
    }

    async function fetchCrafty() {
      const url = `/api/v2/servers/${CONFIG.serverId}/stats`;
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), 8000);

      try {
        const res = await fetch(url, {
          headers: {
            'Accept': 'application/json'
          },
          signal: controller.signal,
          cache: 'no-store'
        });
        clearTimeout(t);

        if (!res.ok) throw new Error(`Crafty API error ${res.status}`);
        const json = await res.json();
        const data = json?.data ?? json;

        if (!data || data.running === false) {
          setOffline();
          return;
        }
        
        $("#uptime").textContent    = formatUptimeFromStarted(data.started);
        $("#players").textContent   = `${data.online}/${data.max}`;
        $("#resources").textContent = `${data.cpu}% CPU / ${data.mem_percent}% RAM (${data.mem})`;
        $("#worldsize").textContent = data.world_size || "—";
        $("#motd").textContent      = data.desc || "—";
        $("#version").textContent   = data.version || "—";

      } catch (err) {
        console.error('fetchCrafty error:', err);
        setOffline();
      }
    }

    fetchCrafty();
    setInterval(fetchCrafty, CONFIG.pollMs);

  </script>
</body>
</html>
